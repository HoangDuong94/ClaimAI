<core:FragmentDefinition
    xmlns="sap.m"
    xmlns:core="sap.ui.core"
    xmlns:l="sap.ui.layout"
    xmlns:f="sap.f">
    
    <VBox height="100%" class="modernChatContainer">
        <!-- SAP Horizon Chat Header -->
        <dependents>
            <Popover
                id="mentionPopover"
                class="cpMentionPopover"
                placement="Auto"
                showHeader="false"
                showArrow="false"
                contentWidth="28rem"
                horizontalScrolling="false"
                afterClose="onMentionPopoverClosed">
                <List
                    id="mentionList"
                    mode="SingleSelectMaster"
                    includeItemInSelection="true"
                    showSeparators="None"
                    itemPress="onMentionListItemPress"
                    items="{chat>/suggestions}">
                    <items>
                        <CustomListItem type="Active" press="onMentionItemPress">
                            <VBox width="100%" class="cpMentionItem">
                                <Text text="{chat>text}" wrapping="true" class="cpMentionItemText"/>
                            </VBox>
                        </CustomListItem>
                    </items>
                </List>
            </Popover>
        </dependents>

        <HBox class="modernChatHeader" justifyContent="SpaceBetween" alignItems="Center">
            <HBox alignItems="Center">
                <core:Icon src="sap-icon://discussion-2" class="modernHeaderIcon"/>
                <VBox class="sapUiTinyMarginBegin">
                    <Title text="PureAI Agent" level="H5" class="modernHeaderTitle"/>
                </VBox>
            </HBox>
            <HBox>
                <Button
                    id="notificationsButton"
                    icon="{= ${notifications>/hasNew} ? 'sap-icon://email' : 'sap-icon://email-read' }"
                    type="{= ${notifications>/hasNew} ? 'Emphasized' : 'Transparent' }"
                    tooltip="Ungelesene Mails"
                    text="{= ${notifications>/unreadCount} ? ${notifications>/unreadCount} : '' }"
                    press="onToggleNotifications"
                    ariaLabel="Ungelesene Mails anzeigen"/>
                <Button 
                    icon="sap-icon://restart" 
                    type="Transparent" 
                    tooltip="Neuer Chat"
                    press="onClearChatHistory"
                    class="modernHeaderButton"
                    ariaLabel="Neuen Chat starten"/>
                <Button 
                    icon="sap-icon://action-settings" 
                    type="Transparent" 
                    tooltip="Einstellungen"
                    class="modernHeaderButton"
                    ariaLabel="Einstellungen öffnen"/>
            </HBox>
        </HBox>

        <!-- Notifications Popover -->
        <Popover id="notificationsPopover" placement="Bottom" contentWidth="420px" title="Neue E-Mails">
            <List id="notificationsList" items="{notifications>/items}" showSeparators="Inner">
                <CustomListItem>
                    <content>
                        <VBox class="sapUiSmallMargin">
                            <HBox justifyContent="SpaceBetween" alignItems="Center">
                                <Link text="{notifications>subject}" press="onOpenNotificationLink" wrapping="true"/>
                                <Text text="{notifications>receivedLabel}"/>
                            </HBox>
                            <ObjectStatus text="{notifications>category}" state="{notifications>categoryState}" visible="{= !!${notifications>category} }" class="sapUiTinyMarginTop"/>
                            <HBox alignItems="Center" justifyContent="SpaceBetween">
                                <Text text="{notifications>summary}" wrapping="true" renderWhitespace="true">
                                    <layoutData>
                                        <FlexItemData growFactor="1"/>
                                    </layoutData>
                                </Text>
                                <core:Icon src="sap-icon://attachment" visible="{notifications>hasAttachments}" class="sapUiTinyMarginBegin" tooltip="Anhang vorhanden"/>
                            </HBox>
                            <Text text="{notifications>fromDisplay}"/>
                            <HBox justifyContent="End" class="sapUiTinyMarginTop">
                                <Button text="An Agent senden" type="Emphasized" press="onSendNotificationToAgent"/>
                                <Button text="Schließen" type="Transparent" press="onCloseNotification"/>
                                <!--
                                    Button für künftiges „Als gelesen“ vorerst deaktiviert.
                                    <Button text="Als gelesen" type="Transparent" press="onMarkNotificationRead"/>
                                -->
                            </HBox>
                        </VBox>
                    </content>
                </CustomListItem>
            </List>
        </Popover>

        <!-- Chat Messages Area -->
        <ScrollContainer 
            id="chatHistoryScrollContainerInSidePanel"
            height="100%" 
            vertical="true" 
            horizontal="false"
            class="modernChatMessagesContainer">
            
            <VBox class="modernMessagesWrapper">
                <!-- Chat Messages List -->
                <List 
                    id="chatMessagesList"
                    items="{chat>/chatHistory}"
                    showSeparators="None"
                    mode="None"
                    showNoData="false"
                    class="modernMessagesList">
                    
                    <CustomListItem class="modernMessageItem">
                        <content>
                            <!-- User Message -->
                            <VBox visible="{= ${chat>type} === 'user' }" class="modernUserMessageContainer">
                                <HBox justifyContent="End" class="modernMessageRow">
                                    <VBox class="modernUserMessage">
                                        <core:HTML content="{chat>text}" sanitizeContent="false" class="modernMessageText modernUserText"/>
                                        <Text text="{chat>timestamp}" class="modernTimestamp modernUserTimestamp"/>
                                    </VBox>
                                </HBox>
                            </VBox>
                            
                            <!-- Assistant Message -->
                            <VBox visible="{= ${chat>type} === 'assistant' }" class="modernAssistantMessageContainer">
                                <HBox justifyContent="Start" class="modernMessageRow">
                                    <VBox class="modernAssistantMessage">
                                        <core:HTML content="{chat>text}" sanitizeContent="false" class="modernMessageText modernAssistantText"/>
                                        <HBox justifyContent="SpaceBetween" alignItems="Center" class="modernMessageFooter">
                                            <Text text="{chat>timestamp}" class="modernTimestamp modernAssistantTimestamp"/>
                                            <HBox class="modernMessageActions" visible="{= ${chat>text} !== 'Thinking...' }">
                                                <Button 
                                                    icon="sap-icon://copy" 
                                                    type="Transparent" 
                                                    tooltip="Kopieren"
                                                    press="onCopyMessage"
                                                    class="modernActionButton"
                                                    ariaLabel="Nachricht kopieren"/>
                                            </HBox>
                                        </HBox>
                                    </VBox>
                                </HBox>
                            </VBox>
                            
                            <!-- System Message -->
                            <VBox visible="{= ${chat>type} === 'system' }" class="modernSystemMessageContainer">
                                <HBox justifyContent="Center" class="modernMessageRow">
                                    <VBox class="modernSystemMessage">
                                        <Text text="{chat>text}" class="modernSystemText" renderWhitespace="true"/>
                                    </VBox>
                                </HBox>
                            </VBox>
                            
                            <!-- Info Message -->
                            <VBox visible="{= ${chat>type} === 'info' }" class="modernInfoMessageContainer">
                                <HBox justifyContent="Center" class="modernMessageRow">
                                    <HBox class="modernInfoMessage" alignItems="Center">
                                        <core:Icon src="sap-icon://information" class="modernInfoIcon"/>
                                        <Text text="{chat>text}" class="modernInfoText" renderWhitespace="true"/>
                                    </HBox>
                                </HBox>
                            </VBox>
                            
                            <!-- Warning Message -->
                            <VBox visible="{= ${chat>type} === 'warning' }" class="modernWarningMessageContainer">
                                <HBox justifyContent="Center" class="modernMessageRow">
                                    <HBox class="modernWarningMessage" alignItems="Center">
                                        <core:Icon src="sap-icon://warning" class="modernWarningIcon"/>
                                        <Text text="{chat>text}" class="modernWarningText" renderWhitespace="true"/>
                                    </HBox>
                                </HBox>
                            </VBox>
                        </content>
                    </CustomListItem>
                </List>
                
                <!-- Typing Indicator -->
                <HBox 
                    visible="{chat>/isTyping}" 
                    justifyContent="Start" 
                    class="modernTypingContainer modernMessageRow">
                    <VBox class="modernTypingMessage">
                        <HBox alignItems="Center">
                            <VBox class="modernTypingIndicator">
                                <core:Icon src="" class="modernTypingDot modernTypingDot1"/>
                                <core:Icon src="" class="modernTypingDot modernTypingDot2"/>
                                <core:Icon src="" class="modernTypingDot modernTypingDot3"/>
                            </VBox>
                            <Text text="AI Assistant schreibt..." class="modernTypingText"/>
                        </HBox>
                    </VBox>
                </HBox>
            </VBox>
        </ScrollContainer>

        <!-- Simple Input Area -->
        <VBox class="modernInputContainer">
            <!-- Input Row -->
            <HBox class="modernInputRow" alignItems="End">
                <VBox class="modernInputWrapper" width="100%">
                    <TextArea
                        id="chatInputField"
                        value="{chat>/userInput}"
                        liveChange="onInputLiveChange"
                        placeholder="Nachricht an PureAI Agent..."
                        rows="3"
                        maxLength="4000"
                        width="100%"
                        growing="true"
                        growingMaxLines="6"
                        submit="onSendChatMessageInSidePanel"
                        class=""
                        ariaLabel="Chat Eingabe"/>
                </VBox>
                
                <Button
                    id="sendButton"
                    icon="sap-icon://paper-plane"
                    type="Transparent"
                    press="onSendChatMessageInSidePanel"
                    class=""
                    ariaLabel="Nachricht senden"/>
            </HBox>
            
            <!-- Minimaler Input Footer -->
            <HBox justifyContent="End" alignItems="Center" class="modernInputFooter">
                <Text text="{= ${chat>/userInput}.length}/4000" class="modernCharCounter" visible="{= ${chat>/userInput}.length > 3800 }"/>
                <Text text="{chat>/statusMessage}" class="modernStatusMessage"/>
            </HBox>
        </VBox>
    </VBox>
</core:FragmentDefinition>
